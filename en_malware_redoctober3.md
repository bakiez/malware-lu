# Analysis of the sample "Red October" - Part 3 #


## Introduction ##

This article deals about the malware Red October. This part explains the real part of this malware. This malware is a really classic trojan, it uses a web C&C.

A complete commented .idb file for IDA Pro Free is available here: http://malware-lu.googlecode.com/git/redoctober/ida/red.idb

## Creation of a thread with the real malicious code ##

The library starts firstly DllMain() and then with the function dispatcher() (sub\_10001100):

![http://malware-lu.googlecode.com/git/redoctober/img/part3-1.png](http://malware-lu.googlecode.com/git/redoctober/img/part3-1.png)

In this function, SetTimer() is used to periodically execute the function TimerFunc() (sub\_10001040):

![http://malware-lu.googlecode.com/git/redoctober/img/part3-2.png](http://malware-lu.googlecode.com/git/redoctober/img/part3-2.png)

TimeFunc() creates a thread and executes the function CC\_handler\_switch\_0() (sub\_10001020) in this thread:

![http://malware-lu.googlecode.com/git/redoctober/img/part3-3.png](http://malware-lu.googlecode.com/git/redoctober/img/part3-3.png)

The function CC\_handler\_switch\_0() simply calls the function CC\_handler\_switch() (sub\_100013A0). This function is the main function of this trojan. Here is the global graph of this function:

![http://malware-lu.googlecode.com/git/redoctober/img/part3-4.png](http://malware-lu.googlecode.com/git/redoctober/img/part3-4.png)

## The workflow of the malware ##

Here is step by step the execution (to follow the execution, we strongly recommand to download the .idb file mentionned at the begining of the article):
  * execution of getmachineidentifier() (sub\_1000DD70): this function retrieves system information such as Window directory, volume info, IE version...
  * execution contactCC\_0() (sub\_10003F00): this function reads the configuration of the browsers and forges the HTTP request (using POST method) to contact the CC. The list of the CC is available at this adress: 0x10025008 (nt-windows-online.com;...), the port is available at this adress: 0x10025028 (80) and the path is available at this adress: 0x10025024 (/cgi-bin/nt/th). The communication uses a XOR, the malware needs to decode the data. The key of the XOR is a rand() with the seed 12345.

![http://malware-lu.googlecode.com/git/redoctober/img/part3-5.png](http://malware-lu.googlecode.com/git/redoctober/img/part3-5.png)

  * the CC gives the order to the infected machine. A switch is used to execute specific code according to the order of the cc.
  * case 0x4: execute a binary stored localy:

![http://malware-lu.googlecode.com/git/redoctober/img/part3-6.png](http://malware-lu.googlecode.com/git/redoctober/img/part3-6.png)

  * case 0x3: download a file and execute this file:

![http://malware-lu.googlecode.com/git/redoctober/img/part3-7.png](http://malware-lu.googlecode.com/git/redoctober/img/part3-7.png)

  * case 0x6: download a file:

![http://malware-lu.googlecode.com/git/redoctober/img/part3-8.png](http://malware-lu.googlecode.com/git/redoctober/img/part3-8.png)

  * case 0x7: install a new version of the malware:

![http://malware-lu.googlecode.com/git/redoctober/img/part3-9.png](http://malware-lu.googlecode.com/git/redoctober/img/part3-9.png)

  * case by default: do nothing

## Conclusion ##

**This sample is a really classic trojan. It periodically connects to a CC by forging its requets and receive an order. The order can be: download a file, dowload and execute a file, execute a file or install another version of the malware. To conclude with this APT, it does not include advanced techniques. The only complexity is the targets of this malware.**