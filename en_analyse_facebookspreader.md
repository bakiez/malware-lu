# Facebook Spreader Virus #

## Introduction ##
This page presents the analysis of a virus that modifies the web requests, in order to add a link to a message when the user posts a new message in a social network. We will unwrap and then analyse the virus.

We will work on the following file:

md5: 270c66954ed73885bc463923bb81ebff

[Virus total information](https://www.virustotal.com/file/b56849bc11d1c8e2d73dedf82ad45d354cbe055d66d759cd8679f3d809800b59/analysis/) analysed at 2012-04-16 23:33:55 UTC

## Tools ##
  * A debugger for dynamic analysis (in our case [OllyDbg](http://www.ollydbg.de/))
  * [LordPE](http://www.woodmann.com/collaborative/tools/index.php/LordPE) in order to dump a memory page
  * [IDA 5.0 free](http://www.hex-rays.com/products/ida/support/download_freeware.shtml) The idb of the analysed files are provided ([270c66954ed73885bc463923bb81ebff.packer.idb](http://code.google.com/p/malware-lu/source/browse/facebookspreader/idb/270c66954ed73885bc463923bb81ebff.packer.idb) and [facebookspreader.idb](http://code.google.com/p/malware-lu/source/browse/facebookspreader/idb/4128e7521acfac1cf25a0d02d17deef6.facebookspreader.idb)). Hereof, by convention, we will define the name of the functions based on their virtual address followed by the name defined in the idb, inside brackets. Example: DEADBEEFh (deadbeef).

## Part 1, unpack ##

### Static analysis ###

You can find more information about the idb for IDA [270c66954ed73885bc463923bb81ebff.packer.idb](http://code.google.com/p/malware-lu/source/browse/facebookspreader/idb/270c66954ed73885bc463923bb81ebff.packer.idb).

We start by opening it with in IDA.
Suspicious aspects that make us think of a packer:
**The start function begins with a long series of:
  * xor eax,eax
  * The imports table is empty
  * There is a big amount of data in the binary
  * No useful string**

Let us verify using PEID that the binary has not been packed using a known packer and let us observe the resources using “Resource Hacker”, for example.
In our case, nothing has been detected and there are no resources.

Coming back to IDA

One string seems suspicious
```
.data:00406030 00000097 C 9k0vKWpiIPEbPdeRvOuMbgMh585k...
```

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-string.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-string.png)

Let us show the references to this string and we find the function
004017F8h (decode):

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-decode-loop.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-decode-loop.png)

This looks like the usage of a key in a decrypting loop that we can write as follows:

```c

void decode(unsigned char *data, int data_len, int key_len){
if(data_len == 0)
return;
int i, j, k = 0;
for ( i=0; i < data_len; ++i){
// Bogus but that's right
if( k == key_len) k = 0; else k++;

for(j = 0; j < 50; j++){
data[i] ^= j;
}
data[i] ^= key[k];
}
}
```

The data decoded at the address 004065E0h (byte\_4065E0) over E9h bytes

```
y0ug@malware.lu:~$ ./decode-data 270c66954ed73885bc463923bb81ebff.exe | hd
00000000  8d 54 24 08 cd 2e 83 c4  04 c3 00 00 00 00 00 00  |.T$.............|
00000010  53 00 6f 00 66 00 74 00  77 00 61 00 72 00 65 00  |S.o.f.t.w.a.r.e.|
00000020  5c 00 4d 00 69 00 63 00  72 00 6f 00 73 00 6f 00  |\.M.i.c.r.o.s.o.|
00000030  66 00 74 00 5c 00 57 00  69 00 6e 00 64 00 6f 00  |f.t.\.W.i.n.d.o.|
00000040  77 00 73 00 5c 00 43 00  75 00 72 00 72 00 65 00  |w.s.\.C.u.r.r.e.|
00000050  6e 00 74 00 56 00 65 00  72 00 73 00 69 00 6f 00  |n.t.V.e.r.s.i.o.|
00000060  6e 00 5c 00 52 00 75 00  6e 00 00 00 43 00 3a 00  |n.\.R.u.n...C.:.|
00000070  5c 00 53 00 45 00 4c 00  46 00 2e 00 45 00 58 00  |\.S.E.L.F...E.X.|
00000080  45 00 00 00 75 00 73 00  65 00 72 00 33 00 32 00  |E...u.s.e.r.3.2.|
00000090  00 00 00 00 61 00 64 00  76 00 61 00 70 00 69 00  |....a.d.v.a.p.i.|
000000a0  33 00 32 00 00 00 00 00  75 00 72 00 6c 00 6d 00  |3.2.....u.r.l.m.|
000000b0  6f 00 6e 00 00 00 00 00  73 00 68 00 65 00 6c 00  |o.n.....s.h.e.l.|
000000c0  6c 00 33 00 32 00 00 00  73 00 68 00 6c 00 77 00  |l.3.2...s.h.l.w.|
000000d0  61 00 70 00 69 00 00 00  33 c9 8d 54 24 08 64 ff  |a.p.i...3..T$.d.|
000000e0  15 c0 00 00 00 83 c4 04  c3                       |.........|
000000e9
```

After decoding many parts, we note that only a few Unicode strings are able to provide us with much information.

By looking at above the key, we note 11 DWORD with many references to each one.

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-fonctions.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-fonctions.png)

We look at the references of a DWORD and we see a call 0040602Ch (DWORD\_40602C)

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-references.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-references.png)

We conclude that the code will use these DWORD to store the pointers to the system libraries’ functions. This will be useful for the dynamic analysis.

Note that all these DWORD have the function 004020F8h (sub\_4020F8) in common, which make us believe that this function is used to call GetProcAddress to find the addresses to the functions.

### Dynamic analysis ###

From what we have seen so far, we assume that the program will write the addresses comprised between 00406004h and 0040602Ch. Let us define the memory breakpoints at the moment the program is writing to these addresses, in order to clearly see the external functions called by the program.

![http://malware-lu.googlecode.com/git/facebookspreader/img/ollydbg-memory-write.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ollydbg-memory-write.png)

At the first breakpoint we are in the following situation, which makes possible to recognise the functions that will be pointed by the pointer.

![http://malware-lu.googlecode.com/git/facebookspreader/img/ollydbg-memory-breakpoint.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ollydbg-memory-breakpoint.png)

Then we can find the addresses:
![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-ok.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-ok.png)

We believe that pWriteProcessMemory is worth to analyse, then we set a breakpoint to check if we can observe something interesting.

First breakpoint on WriteProcessMemory:

```c

WriteProcessMemory(
HANDLE hProcess = 0x54,
LPVOID lpBaseAddress = 0x400000,
PCVOID lpBuffer = 0x08B0000,
SIZE_T 1024,
SIZE_T NULL
)
```

At the address 08B0000h we find:

![http://malware-lu.googlecode.com/git/facebookspreader/img/dump-8b0000.png](http://malware-lu.googlecode.com/git/facebookspreader/img/dump-8b0000.png)

We note the beginning of PE and then we dump this page to verify that we have a complete binary.

![http://malware-lu.googlecode.com/git/facebookspreader/img/lordpe-dmp.png](http://malware-lu.googlecode.com/git/facebookspreader/img/lordpe-dmp.png)

The page starts directly with MZ, and then, we do not need to clean the dump.

We try to open this dump in IDA and it works.

During the analysis of the code, a DWORD was attracting our attention because it almost corresponded to the size of the executable.

```
.data:00406134 binary_file_size dd 21200h              ; DATA XREF: sub_40285D+20r
```

Maybe the file contains garbage only, which is not serious. However we will clean it.

```
y0ug@malware.lu:~$ du -b Region008B0000-008D2000.dmp.exe
139264	Region008B0000-008D2000.dmp.exe
y0ug@malware.lu:~$ pcalc 0x21200
	135680          	0x21200           	0y100001001000000000
y0ug@malware.lu:~$ # Similar size. Then, there would be 3584bytes of garbage
y0ug@malware.lu:~$ head -c 135680 Region008B0000-008D2000.dmp.exe > facebookspreader.exe
y0ug@malware.lu:~$ md5sum facebookspreader.exe 
4128e7521acfac1cf25a0d02d17deef6  facebookspreader.exe
```

## Part 2, binary analysis ##

### Introduction ###

Additional information can be found in the IDA’s idb.
[facebookspreader.idb](http://code.google.com/p/malware-lu/source/browse/facebookspreader/idb/4128e7521acfac1cf25a0d02d17deef6.facebookspreader.idb).

We will not explore all the details of this binary.

Hash md5: [4128e7521acfac1cf25a0d02d17deef6](http://www.malware.lu/_download.php?md5=4128e7521acfac1cf25a0d02d17deef6)

[Virus total information](https://www.virustotal.com/file/f29dd7d6404cfaefc546e38290153247c94cbaf4e22b6336a198da2f60c137d4/analysis/)

We start with the WinMain.

### Anti-reverse ###

The first function called, 0040BC70h (anti\_reverse), carries out many verifications in order to check if it is not running in an analysis environment:
**000401880h (anti\_usualname) checks if the filename does not contain one of the following words: « virus », « sand-box », « sandbox », « malware », « test », and then if the computer name is not one of the following: « VMG-CLIENT », « MAKK », « Malekal », « HOME-OFF-D5F0AC » , « DELL-D3E62F7E26 », « KAKAPROU-6405DA" etc.
  * 00401780h (anti\_vm) and 00401110h (anti\_vm2) verifies the absence of virtual machine tools
  * 00401420h (anti\_networkanalyse) and 00401500h (anti\_networkanalyse) verifies the absence of network analysis tools.**

In case of detection, the binary deletes itself by calling the function 00403730h (self\_delete).

### C&C URL ###

The second function 0040BC20h (decode) decode the URL.

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-decode-url.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-decode-url.png)

The key is stored at 0041FD4Ch (xor\_key) the offset in the binary is 0001E14Ch, the size is stored at 0041FD10h (xor\_key\_len) and its value is 0Bh.

Which gives [decode-url.py](http://code.google.com/p/malware-lu/source/browse/facebookspreader/code/decode-url.py):

```py

def decode(data, key):
ret = "";
for i in range(0, len(data)):
c = ord(data[i]) ^ ord(key[i % (len(key))])
ret += chr(c)
return ret
```

Two URLs are stored in the binary 0041FD14h (strXorUrl) and 0041FD30h (strXorUrl2), but they point to the same domain:

http://i.devbug.su:81/i/

### Information about the domain ###

```
y0ug@malware.lu:~$ nslookup i.devbug.su 8.8.8.8
...
Non-authoritative answer:
Name:	i.devbug.su
Address: 46.166.143.129

y0ug@malware.lu:~$ whois 46.166.143.129
...
% Information related to '46.166.143.0 - 46.166.143.255'
inetnum:         46.166.143.0 – 46.166.143.255
netname:         SANTREX-INTERNET-SERVICES
descr:           Santrex Internet Services
country:         LU
admin-c:         KC1261-RIPE
tech-c:          KC1261-RIPE
status:          ASSIGNED PA
mnt-by:          Cook08
mnt-by:          ROOT-MNT
mnt-lower:       Cook08
source:          RIPE # Filtered

person:          Khalid Cook
address:         Santrex Internet Services Ltd.
address:         PO Box 66387
address:         E14 1LR
address:         London, UK
phone:           +442075316044
abuse-mailbox:   abuse@santrex.net
nic-hdl:         KC1261-RIPE
mnt-by:          Cook08
source:          RIPE # Filtered
% Information related to '46.166.143.0/24AS5577'
route:           46.166.143.0/24
descr:           SANTREX
origin:          AS5577
mnt-by:          ROOT-MNT
source:          RIPE # Filtered
% This query was served by the RIPE Database Query Service version 1.6.12 (WHOIS1)

y0ug@malware.lu:~/CTF/malware/FacebookSpreader/code$ whois devbug.su
...
domain:        DEVBUG.SU
nserver:       ns1.freedns.ws.
nserver:       ns2.freedns.ws.
nserver:       ns3.freedns.ws.
nserver:       ns4.freedns.ws.
state:         REGISTERED, DELEGATED
person:        Private Person
e-mail:        info@devbug.su
registrar:     NAUNET-REG-FID
created:       2012.03.21
paid-till:     2013.03.21
free-date:     2013.04.23
source:        TCI
Last updated on 2012.04.26 13:20:46 MSK
```

IP localisation by MaxMind Luxembourg.

### C&C communication ###

After getting the URLs, it calls the function 004035F0h (ReadUrl) using 0041FD14h (strXorUrl), and then it copies the data to read\_data1 in the stack. Similar using 0041FD30h (strXorUrl2).

Prototype:
```
char *ReadUrl(char *url)
```

![http://malware-lu.googlecode.com/git/facebookspreader/img/img-ida-readurl.png](http://malware-lu.googlecode.com/git/facebookspreader/img/img-ida-readurl.png)

Data returned by the C&C from a LU IP:
```
y0ug@malware.lu:~$ curl http://i.devbug.su:81/i/
sont ces nouvelles photos de vos? http://bit.ly/I0xWlQ
avez-vous vu ces nouvelles photos de vous? http://bit.ly/IbGSY2
bonjour est-ce pic de votre? http://bit.ly/JJr0NF
j'aime vos nouvelles photos! http://bit.ly/IbGQQ2
...
```

Data returned by the C&C from a NL IP
```
y0ug@malware.lu:~$ curl http://i.devbug.su:81/i/ 
lol? http://bit.ly/K8pxvu 
:D http://bit.ly/K0xDqL 
;) http://bit.ly/IbGQQ8 
lol? http://bit.ly/IhIJXV 
...
```

We note that for different countries, different messages are returned. At the time of the test, on the 26/04/2012 the links bit.ly pointed to an ZIP archive hosted at hotfile.com

The archive name is IMG\_15\_April25\_www.Facebook.com\_Profile.zip and the md5 hash is 954d34a2ffa6a4bf86719ea139a75c73. Once unzipped, there is only one binary called IMG\_April25\_894651810598.exe and the corresponding hash is 9b86b28ba9c312db24af41e67649327c.

We proceed to the function 004033D0h (CmdHandler) that runs in a loop. It injects the code in the different browsers and gets the new messages from the server.

In 004033D0h (CmdHandler) we note that the virus can receive six commands:
  * ##STOP## stop changing all requests
  * ##STOPFC## stop changing Facebook requests
  * ##STOPHOOK## stop changing all requests
  * ##STOPTWIT## stop changing Twitter requests
  * ##STOPMYSPACE## stop changing MySpace requests
  * ##STOPYOUTUBE## stop changing YouTube requests

### Hook ###

Its goal is to propagate other binaries. For that, it injects itself in the processes of different browsers in order to hook the network functions.

Function 00402740h (InjectHookBrowser) and then function 00402640h (injectCode) use the following external functions in order to execute the thread 00402D60h (thrHookInjected) in the browser:
  * OpenProcess
  * GetModuleHandle
  * VirtualAllocEx
  * WriteProcessMemory
  * CreateRemoteThread

The setup of the hooks is performed in the function 00402AF0 (HookSetup). It will hook the following functions by:
  * wininet.dll: InternetWriteFile -> 004077C0h (HookInternetWriteFile)
  * wininet.dll: InternetReadFile -> 004075C0h (HookInternetReadFile)
  * wininet.dll: HttpSendRequestW -> 00406D50h (HookHttpSendRequest)
  * nspr4.dll: PR\_Write -> 00404410h (HookPRWrite)
  * nspr4.dll PR\_Read -> 00404050h (HookPRRead)
  * Ws2\_32.dll: WSASend -> 00409A50h (HookWSASend)

The goal of these hooks is to analyse what is sent. If it recognises a known pattern, it replaces the message sent by one retrieved from the C&C. By looking at the strings contained in the binary, we find the searched patterns.

From the information above, we conclude that the virus targets the following social networks: Facebook, MySpace, Twitter, YouTube, Wordpress.com (manque le “d” en français aussi?).

We noted some traces of debug strings in the hook functions that are used with an empty function.

![http://malware-lu.googlecode.com/git/facebookspreader/img/debug-string.png](http://malware-lu.googlecode.com/git/facebookspreader/img/debug-string.png)

### Persistence ###

The virus does not install itself; neither it is executed at the start or a kill of a process. We realise that it does not write any file neither it modifies the system.

To verify: maybe the packer installs a registry key to be launch at the boot time

## Conclusion ##

The main goal of this virus is to propagate itself through the social networks. With that objective it modifies the user requests at the moment a message is sent to one of the target services, in order to replace it by the content received from the C&C.

<a href='Hidden comment: 
We will note the non-persistence of the virus, maybe, in order to not arousing suspicion or at the end of the test.
'></a>

For information, the binary propagated during the analysis, is different from the other one. At first sight, it consists of opening a shell on the user’s port 8000.
