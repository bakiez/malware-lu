# Facebook Spreader Virus #

## Introduction ##
Cette page présente une analyse d'un virus qui altère les requêtes web, afin de poster un message avec un lien sur des réseaux sociaux lorsqu'une personne poste un message. Nous verrons le dépaquetage puis l'analyse du virus.

Nous travaillerons sur le fichier suivant :

md5 : 270c66954ed73885bc463923bb81ebff

[Virus total information](https://www.virustotal.com/file/b56849bc11d1c8e2d73dedf82ad45d354cbe055d66d759cd8679f3d809800b59/analysis/) scanné le 2012-04-16 23:33:55 UTC

## Outils ##
  * Un débogueur pour l'analyse dynamique (dans notre cas [OllyDbg](http://www.ollydbg.de/))
  * [LordPE](http://www.woodmann.com/collaborative/tools/index.php/LordPE) afin de dumper une page mémoire
  * [IDA 5.0 free](http://www.hex-rays.com/products/ida/support/download_freeware.shtml) Les idb des fichiers analysés sont fournis ([270c66954ed73885bc463923bb81ebff.packer.idb](http://code.google.com/p/malware-lu/source/browse/facebookspreader/idb/270c66954ed73885bc463923bb81ebff.packer.idb) et [facebookspreader.idb](http://code.google.com/p/malware-lu/source/browse/facebookspreader/idb/4128e7521acfac1cf25a0d02d17deef6.facebookspreader.idb)). Dans ce qui suit, par convention, on nommera les fonctions par leur adresse virtuelle suivi entre parenthèses du nom donné dans l'idb. Example: DEADBEEFh (viandemorte).

## Part 1, unpack ##

### Analyse statique ###

Vous trouverez plus d'information dans l'idb pour IDA [270c66954ed73885bc463923bb81ebff.packer.idb](http://code.google.com/p/malware-lu/source/browse/facebookspreader/idb/270c66954ed73885bc463923bb81ebff.packer.idb).

Nous commençons par l'ouvrir avec IDA.
Points suspects qui font penser à un packer :
  * La fonction start commence avec une grande série de :
    * xor eax,eax
  * La table des imports vide
  * On remarque une grande portion de data dans le binaire
  * Aucun string utile

Vérifions avec PEID que le binaire n'est pas packet avec un packer connu et regardons les ressources avec Resource Hacker par exemple.
Dans notre cas rien de détecté et pas de ressource.

Retour sous IDA

Une des strings parait suspect
```
.data:00406030 00000097 C 9k0vKWpiIPEbPdeRvOuMbgMh585k...
```

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-string.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-string.png)

Affichons les références à ce string, nous trouvons cette fonction 004017F8h (decode) :

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-decode-loop.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-decode-loop.png)

Cela ressemble à une utilisation comme clé dans une boucle de déchiffrement que nous pouvons écrire de cette façon :

```c

void decode(unsigned char *data, int data_len, int key_len){
if(data_len == 0)
return;
int i, j, k = 0;
for ( i=0; i < data_len; ++i){
// Bogus but that's right
if( k == key_len) k = 0; else k++;

for(j = 0; j < 50; j++){
data[i] ^= j;
}
data[i] ^= key[k];
}
}
```

Les données décodées à l'adresse 004065E0h (byte\_4065E0) sur E9h bytes

```
y0ug@malware.lu:~$ ./decode-data 270c66954ed73885bc463923bb81ebff.exe | hd
00000000  8d 54 24 08 cd 2e 83 c4  04 c3 00 00 00 00 00 00  |.T$.............|
00000010  53 00 6f 00 66 00 74 00  77 00 61 00 72 00 65 00  |S.o.f.t.w.a.r.e.|
00000020  5c 00 4d 00 69 00 63 00  72 00 6f 00 73 00 6f 00  |\.M.i.c.r.o.s.o.|
00000030  66 00 74 00 5c 00 57 00  69 00 6e 00 64 00 6f 00  |f.t.\.W.i.n.d.o.|
00000040  77 00 73 00 5c 00 43 00  75 00 72 00 72 00 65 00  |w.s.\.C.u.r.r.e.|
00000050  6e 00 74 00 56 00 65 00  72 00 73 00 69 00 6f 00  |n.t.V.e.r.s.i.o.|
00000060  6e 00 5c 00 52 00 75 00  6e 00 00 00 43 00 3a 00  |n.\.R.u.n...C.:.|
00000070  5c 00 53 00 45 00 4c 00  46 00 2e 00 45 00 58 00  |\.S.E.L.F...E.X.|
00000080  45 00 00 00 75 00 73 00  65 00 72 00 33 00 32 00  |E...u.s.e.r.3.2.|
00000090  00 00 00 00 61 00 64 00  76 00 61 00 70 00 69 00  |....a.d.v.a.p.i.|
000000a0  33 00 32 00 00 00 00 00  75 00 72 00 6c 00 6d 00  |3.2.....u.r.l.m.|
000000b0  6f 00 6e 00 00 00 00 00  73 00 68 00 65 00 6c 00  |o.n.....s.h.e.l.|
000000c0  6c 00 33 00 32 00 00 00  73 00 68 00 6c 00 77 00  |l.3.2...s.h.l.w.|
000000d0  61 00 70 00 69 00 00 00  33 c9 8d 54 24 08 64 ff  |a.p.i...3..T$.d.|
000000e0  15 c0 00 00 00 83 c4 04  c3                       |.........|
000000e9
```

Après avoir décodé plusieurs parties, nous remarquons que cela ne nous apporte pas beaucoup d'information juste quelques strings en Unicode.

En regardant au-dessus de la clé nous remarquons 11 DWORD avec plusieurs références sur chacun.

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-fonctions.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-fonctions.png)

Nous regardons les références d'un DWORD et voyons un call 0040602Ch (DWORD\_40602C)

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-references.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-references.png)

Nous concluons que le code va utiliser ces DWORD pour stocker les pointers vers les fonctions des librairies systèmes. Cela sera utile pour l'analyse dynamique.

Notons que tous ces DWORD ont en commun la fonction 004020F8h (sub\_4020F8) ce qui nous laisse penser que cette fonction s'occupe d'appeler GetProcAddress pour retrouver les adresses vers les fonctions.

### Analyse dynamique ###

De ce que nous avons vu, nous assumons que le programme va aller écrire des adresses entre 00406004h – 0040602Ch. Définissons des breakpoints en écriture sur ces adresses, afin de voir plus clair sur les fonctions externes appelées par le programme.

![http://malware-lu.googlecode.com/git/facebookspreader/img/ollydbg-memory-write.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ollydbg-memory-write.png)

Lors du 1ere breakpoint rencontré nous nous trouvons dans cette situation, qui nous permet de savoir vers qu'elle fonction le pointer va pointer :

![http://malware-lu.googlecode.com/git/facebookspreader/img/ollydbg-memory-breakpoint.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ollydbg-memory-breakpoint.png)

Ainsi nous retrouvons les adresses :

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-ok.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-dword-ok.png)

Nous pensons que pWriteProcessMemory peut-être intéressante, nous mettons un breakpoint dessus pour voir si nous pouvons observer quelque chose d'intéressant.

1ere breakpoint sur WriteProcessMemory :

```c

WriteProcessMemory(
HANDLE hProcess = 0x54,
LPVOID lpBaseAddress = 0x400000,
PCVOID lpBuffer = 0x08B0000,
SIZE_T 1024,
SIZE_T NULL
)
```

À l'adresse 08B0000h on trouve :

![http://malware-lu.googlecode.com/git/facebookspreader/img/dump-8b0000.png](http://malware-lu.googlecode.com/git/facebookspreader/img/dump-8b0000.png)

Nous remarquons un début de PE, « dumpons » cette page pour vérifier que nous avons à faire à un binaire complet.

![http://malware-lu.googlecode.com/git/facebookspreader/img/lordpe-dmp.png](http://malware-lu.googlecode.com/git/facebookspreader/img/lordpe-dmp.png)

La page commence directement par MZ nous avons donc pas besoin de nettoyer le dump.

Nous essayons d'ouvrir ce dump avec IDA et ça fonctionne.

Durant l'analyse du code un DWORD m'avait intrigué qui pouvait correspondre à la taille de l'exécutable.

```
.data:00406134 binary_file_size dd 21200h              ; DATA XREF: sub_40285D+20r
```

Le fichier peut donc contenir du garbage même si cela n'est pas très grave on va quand même le nettoyer

```
y0ug@malware.lu:~$ du -b Region008B0000-008D2000.dmp.exe
139264	Region008B0000-008D2000.dmp.exe
y0ug@malware.lu:~$ pcalc 0x21200
	135680          	0x21200           	0y100001001000000000
y0ug@malware.lu:~$ # Taille très proche il y aurait donc 3584bytes de garbage
y0ug@malware.lu:~$ head -c 135680 Region008B0000-008D2000.dmp.exe > facebookspreader.exe
y0ug@malware.lu:~$ md5sum facebookspreader.exe 
4128e7521acfac1cf25a0d02d17deef6  facebookspreader.exe
```

## Part 2, analyse du binaire ##

### Introduction ###

Vous trouverez plus d'information dans l'idb d'IDA [facebookspreader.idb](http://code.google.com/p/malware-lu/source/browse/facebookspreader/idb/4128e7521acfac1cf25a0d02d17deef6.facebookspreader.idb).

Nous n'allons pas trop rentrer dans les détails de ce binaire.

Hash md5 : [4128e7521acfac1cf25a0d02d17deef6](http://www.malware.lu/_download.php?md5=4128e7521acfac1cf25a0d02d17deef6)

[Virus total information](https://www.virustotal.com/file/f29dd7d6404cfaefc546e38290153247c94cbaf4e22b6336a198da2f60c137d4/analysis/)

Nous commençons par le WinMain.

### Anti-reverse ###

La 1ere fonction appelée 0040BC70h (anti\_reverse) effectue plusieurs vérifications afin de voir s'il se trouve dans un environnement d'analyse :
  * 000401880h (anti\_usualname) verifie que le nom du fichier ne contient pas un des mots suivant « virus », « sand-box », « sandbox », « malware », « test », puis que le nom de l'ordinateur n'est pas dans la liste suivante « VMG-CLIENT », « MAKK », « Malekal », « HOME-OFF-D5F0AC » , « DELL-D3E62F7E26 », « KAKAPROU-6405DA" etc..
  * 00401780h (anti\_vm) et 00401110h (anti\_vm2) vérifient l'existence d'outils de machine virtuelle.
  * 00401420h (anti\_networkanalyse) et 00401500h (anti\_networkanalyse) vérifient qu'il n'y a pas d'outil d'analyse réseau.

En cas de détection le binaire se supprime en appelant la fonction 00403730h (self\_delete).

### C&C URL ###

La 2e fonction 0040BC20h (decode) s'occupe de décoder l'URL

![http://malware-lu.googlecode.com/git/facebookspreader/img/ida-decode-url.png](http://malware-lu.googlecode.com/git/facebookspreader/img/ida-decode-url.png)

La Key se trouve à 0041FD4Ch (xor\_key) l'offset dans le binaire est 0001E14Ch, la taille se trouve à 0041FD10h (xor\_key\_len) elle vaut 0Bh.

Qui donne [decode-url.py](http://code.google.com/p/malware-lu/source/browse/facebookspreader/code/decode-url.py) :

```py

def decode(data, key):
ret = "";
for i in range(0, len(data)):
c = ord(data[i]) ^ ord(key[i % (len(key))])
ret += chr(c)
return ret
```

2 URL sont stockées dans le binaire 0041FD14h (strXorUrl) et 0041FD30h (strXorUrl2), mais pointent sur le même domaine :

http://i.devbug.su:81/i/

### Information sur le domaine ###

```
y0ug@malware.lu:~$ nslookup i.devbug.su 8.8.8.8
...
Non-authoritative answer:
Name:	i.devbug.su
Address: 46.166.143.129

y0ug@malware.lu:~$ whois 46.166.143.129
...
% Information related to '46.166.143.0 - 46.166.143.255'
inetnum:         46.166.143.0 – 46.166.143.255
netname:         SANTREX-INTERNET-SERVICES
descr:           Santrex Internet Services
country:         LU
admin-c:         KC1261-RIPE
tech-c:          KC1261-RIPE
status:          ASSIGNED PA
mnt-by:          Cook08
mnt-by:          ROOT-MNT
mnt-lower:       Cook08
source:          RIPE # Filtered

person:          Khalid Cook
address:         Santrex Internet Services Ltd.
address:         PO Box 66387
address:         E14 1LR
address:         London, UK
phone:           +442075316044
abuse-mailbox:   abuse@santrex.net
nic-hdl:         KC1261-RIPE
mnt-by:          Cook08
source:          RIPE # Filtered
% Information related to '46.166.143.0/24AS5577'
route:           46.166.143.0/24
descr:           SANTREX
origin:          AS5577
mnt-by:          ROOT-MNT
source:          RIPE # Filtered
% This query was served by the RIPE Database Query Service version 1.6.12 (WHOIS1)

y0ug@malware.lu:~/CTF/malware/FacebookSpreader/code$ whois devbug.su
...
domain:        DEVBUG.SU
nserver:       ns1.freedns.ws.
nserver:       ns2.freedns.ws.
nserver:       ns3.freedns.ws.
nserver:       ns4.freedns.ws.
state:         REGISTERED, DELEGATED
person:        Private Person
e-mail:        info@devbug.su
registrar:     NAUNET-REG-FID
created:       2012.03.21
paid-till:     2013.03.21
free-date:     2013.04.23
source:        TCI
Last updated on 2012.04.26 13:20:46 MSK
```

Localisation de l'IP par MaxMind Luxembourg.

### C&C communication ###

Après avoir récupéré les URL, il appelle là fonction 004035F0h (ReadUrl) avec 0041FD14h (strXorUrl) puis copie les données dans read\_data1 sur le stack, pareil avec 0041FD30h (strXorUrl2).

Prototype:
```
char *ReadUrl(char *url)
```

![http://malware-lu.googlecode.com/git/facebookspreader/img/img-ida-readurl.png](http://malware-lu.googlecode.com/git/facebookspreader/img/img-ida-readurl.png)

Données retournées par le C&C à partir d'un IP LU :
```
y0ug@malware.lu:~$ curl http://i.devbug.su:81/i/
sont ces nouvelles photos de vos? http://bit.ly/I0xWlQ
avez-vous vu ces nouvelles photos de vous? http://bit.ly/IbGSY2
bonjour est-ce pic de votre? http://bit.ly/JJr0NF
j'aime vos nouvelles photos! http://bit.ly/IbGQQ2
...
```

Données retournées par le C&C à partir d'un IP NL :
```
y0ug@malware.lu:~$ curl http://i.devbug.su:81/i/ 
lol? http://bit.ly/K8pxvu 
:D http://bit.ly/K0xDqL 
;) http://bit.ly/IbGQQ8 
lol? http://bit.ly/IhIJXV 
...
```

Nous remarquons qu'en fonction du pays des messages/adresses différents sont retournés.
Lors des tests le 26/04/2012 les liens bit.ly pointaient sur une archive ZIP hébergée sur hotfile.com

L'archive porte le nom IMG\_15\_April25\_www.Facebook.com\_Profile.zip est possède le hash md5 suivant 954d34a2ffa6a4bf86719ea139a75c73. Une fois décompactée on trouve 1 seul binaire nommé IMG\_April25\_894651810598.exe avec le hash 9b86b28ba9c312db24af41e67649327c.

On passe à la fonction 004033D0h (CmdHandler) qui tourne en boucle. Elle s'occupe d'injecter le code dans les différents navigateurs et de récupérer les nouveaux messages du serveur.

Dans 004033D0h (CmdHandler) on remarque que le virus peut recevoir 6 commandes :
  * ##STOP## stop toutes les altérations de requête
  * ##STOPFC## stop les altérations de requête de Facebook
  * ##STOPHOOK## stop toutes les altérations de requête
  * ##STOPTWIT## stop les altérations de requête de Twitter
  * ##STOPMYSPACE## stop les altérations de requête de MySpace
  * ##STOPYOUTUBE## stop les altérations de requête de YouTube

### Hook ###

Son but est de propager d'autre binaire, pour cela il s'injecte dans les processus des différents navigateurs afin de hooker les fonctions réseau.

La fonction 00402740h (InjectHookBrowser) puis 00402640h (injectCode) utilisent les fonctions externes suivantes afin d'exécuter le thread 00402D60h (thrHookInjected) dans le contexte du navigateur :
  * OpenProcess
  * GetModuleHandle
  * VirtualAllocEx
  * WriteProcessMemory
  * CreateRemoteThread

La mise en place des hooks se fait dans la fonction 00402AF0 (HookSetup). qui va hooker les fonctions suivantes par :
  * wininet.dll : InternetWriteFile -> 004077C0h (HookInternetWriteFile)
  * wininet.dll : InternetReadFile -> 004075C0h (HookInternetReadFile)
  * wininet.dll : HttpSendRequestW -> 00406D50h (HookHttpSendRequest)
  * nspr4.dll : PR\_Write -> 00404410h (HookPRWrite)
  * nspr4.dll : PR\_Read -> 00404050h (HookPRRead)
  * Ws2\_32.dll : WSASend -> 00409A50h (HookWSASend)

Le but de ces hooks est d'analyser ce qui est envoyé, s'il remarque un pattern connu, il remplace le message envoyé par un de ce récupéré par le C&C. En regardant les strings contenus dans le binaire, on retrouve les différents patterns cherchés.

À partir des informations ci-dessus on en déduit qu'il cible les réseaux sociaux suivant Facebook, MySpace, Twitter, YouTube, Wordpress.com.

Nous remarquons des traces des strings de debug dans les fonctions de hook qui sont utilisées avec une fonction vide.

![http://malware-lu.googlecode.com/git/facebookspreader/img/debug-string.png](http://malware-lu.googlecode.com/git/facebookspreader/img/debug-string.png)

### Persistance ###

Le virus ne s'installe pas, il ne sera pas exécuté après un redémarrage ou un kill du processus. On constate qu'il n'écrit aucun fichier et ne modifie pas le système.

À vérifier : peut être le packer installe une clé registre pour le lancer au boot

## Conclusion ##

Le but principal de ce virus est de se propager par les réseaux sociaux. Pour cela, il modifie à la volée les requêtes de l'utilisateur lors de l'envoi de message sur un des services ciblé, pour le remplacer par un de ce reçu par le C&C.

<a href='Hidden comment: 
Nous noterons là non persistance du virus, peut-être afin de ne pas éveiller les soupçons ou à des fin de test.
'></a>

Pour information le binaire propager pendant l'analyse est différents de celui-là, il s'agit à 1ere vue d'ouvrir un shell sur le port 8000 de l'utilisateur.